<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ValidationEngine.groovy</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">gsvg</a> &gt; <a href="index.source.html" class="el_package">se.alipsa.groovy.svg.validation</a> &gt; <span class="el_source">ValidationEngine.groovy</span></div><h1>ValidationEngine.groovy</h1><pre class="source lang-java linenums">package se.alipsa.groovy.svg.validation

import groovy.transform.CompileStatic
import se.alipsa.groovy.svg.Svg
import se.alipsa.groovy.svg.SvgElement
import se.alipsa.groovy.svg.validation.rules.*

/**
 * Orchestrates SVG validation by applying a set of {@link ValidationRule}s.
 * &lt;p&gt;
 * The engine maintains a collection of validation rules and applies them to
 * SVG elements, collecting issues in a {@link ValidationReport}.
 * &lt;p&gt;
 * By default, the engine is configured with a set of core validation rules.
 * You can customize the rules by adding or removing them:
 * &lt;pre&gt;
 * ValidationEngine engine = ValidationEngine.createDefault()
 * engine.removeRule(&quot;VIEWBOX_RULE&quot;)  // Disable viewBox validation
 * engine.addRule(new MyCustomRule())  // Add custom rule
 *
 * ValidationReport report = engine.validate(svg)
 * &lt;/pre&gt;
 */
@CompileStatic
class ValidationEngine {
<span class="fc" id="L26">    private final Map&lt;String, ValidationRule&gt; rules = [:]</span>

    /**
     * Creates a new validation engine with no rules.
     */
<span class="fc" id="L31">    ValidationEngine() {</span>
<span class="fc" id="L32">    }</span>

    /**
     * Creates a validation engine configured with default core rules.
     * &lt;p&gt;
     * Default rules include:
     * &lt;ul&gt;
     *   &lt;li&gt;RequiredAttributeRule - Validates required attributes per element type&lt;/li&gt;
     *   &lt;li&gt;AttributeValueRule - Validates attribute value ranges and domains&lt;/li&gt;
     *   &lt;li&gt;ElementNestingRule - Validates parent-child relationships&lt;/li&gt;
     *   &lt;li&gt;ViewBoxRule - Validates viewBox dimensions&lt;/li&gt;
     *   &lt;li&gt;HrefRule - Validates href references exist&lt;/li&gt;
     *   &lt;li&gt;DuplicateIdRule - Checks for duplicate IDs&lt;/li&gt;
     *   &lt;li&gt;AccessibilityRule - Validates accessibility attributes and best practices&lt;/li&gt;
     * &lt;/ul&gt;
     *
     * @return engine with default rules
     */
    static ValidationEngine createDefault() {
<span class="fc" id="L51">        ValidationEngine engine = new ValidationEngine()</span>
<span class="fc" id="L52">        engine.addRule(new RequiredAttributeRule())</span>
<span class="fc" id="L53">        engine.addRule(new AttributeValueRule())</span>
<span class="fc" id="L54">        engine.addRule(new ElementNestingRule())</span>
<span class="fc" id="L55">        engine.addRule(new ViewBoxRule())</span>
<span class="fc" id="L56">        engine.addRule(new HrefRule())</span>
<span class="fc" id="L57">        engine.addRule(new DuplicateIdRule())</span>
<span class="fc" id="L58">        engine.addRule(new AccessibilityRule())</span>
<span class="fc" id="L59">        engine</span>
    }

    /**
     * Creates a validation engine with only accessibility rules.
     * &lt;p&gt;
     * Useful for accessibility-focused validation without other structural checks.
     *
     * @return engine with accessibility rule
     */
    static ValidationEngine createAccessibility() {
<span class="fc" id="L70">        ValidationEngine engine = new ValidationEngine()</span>
<span class="fc" id="L71">        engine.addRule(new AccessibilityRule())</span>
<span class="fc" id="L72">        engine</span>
    }

    /**
     * Adds a validation rule to this engine.
     * If a rule with the same ID already exists, it will be replaced.
     *
     * @param rule the rule to add
     * @return this engine for method chaining
     */
    ValidationEngine addRule(ValidationRule rule) {
<span class="fc bfc" id="L83" title="All 4 branches covered.">        if (rule) {</span>
<span class="fc" id="L84">            rules[rule.ruleId] = rule</span>
        }
<span class="fc" id="L86">        this</span>
    }

    /**
     * Removes a validation rule by its ID.
     *
     * @param ruleId the ID of the rule to remove
     * @return this engine for method chaining
     */
    ValidationEngine removeRule(String ruleId) {
<span class="fc" id="L96">        rules.remove(ruleId)</span>
<span class="fc" id="L97">        this</span>
    }

    /**
     * Returns all currently registered rules.
     *
     * @return unmodifiable collection of rules
     */
    Collection&lt;ValidationRule&gt; getRules() {
<span class="fc" id="L106">        Collections.unmodifiableCollection(rules.values())</span>
    }

    /**
     * Gets a specific rule by its ID.
     *
     * @param ruleId the rule ID
     * @return the rule, or null if not found
     */
    ValidationRule getRule(String ruleId) {
<span class="fc" id="L116">        rules[ruleId]</span>
    }

    /**
     * Validates an SVG element and all its descendants.
     * &lt;p&gt;
     * Applies all registered rules to the element and recursively to its children.
     *
     * @param element the element to validate
     * @return validation report with all issues found
     */
    ValidationReport validate(SvgElement element) {
<span class="fc" id="L128">        ValidationReport report = new ValidationReport()</span>
<span class="fc bfc" id="L129" title="All 4 branches covered.">        if (element) {</span>
<span class="fc" id="L130">            validateRecursive(element, report)</span>
        }
<span class="fc" id="L132">        report</span>
    }

    /**
     * Validates an SVG document (root element and all descendants).
     *
     * @param svg the SVG document to validate
     * @return validation report with all issues found
     */
    ValidationReport validate(Svg svg) {
<span class="fc" id="L142">        validate(svg as SvgElement)</span>
    }

    private void validateRecursive(SvgElement element, ValidationReport report) {
        // Apply all rules to this element
<span class="fc" id="L147">        rules.values().each { rule -&gt;</span>
            try {
<span class="fc" id="L149">                rule.validate(element, report)</span>
            } catch (Exception e) {
                // Don't let one rule's exception break validation
<span class="fc" id="L152">                report.addIssue(ValidationIssue.error(</span>
<span class="fc" id="L153">                    &quot;Validation rule '${rule.ruleId}' threw exception: ${e.message}&quot;,</span>
<span class="fc" id="L154">                    element.name,</span>
                    element,
<span class="pc" id="L156">                    rule.ruleId</span>
                ))
            }
        }

        // Recursively validate children
<span class="fc" id="L162">        element.children.each { child -&gt;</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">            if (child instanceof SvgElement) {</span>
<span class="fc" id="L164">                validateRecursive(child as SvgElement, report)</span>
            }
<span class="nc" id="L166">        }</span>
<span class="fc" id="L167">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>